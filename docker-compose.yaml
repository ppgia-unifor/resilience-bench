version: '3.4'

services:  
  polly:
    build:
      context: ./clients/polly
    container_name: polly
  
  resilience4j:
    build:
      context: ./clients/resilience4j
    container_name: resilience4j

  scheduler:
    build: 
      context: ./scheduler
    container_name: scheduler
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./samples/config-all-delay.json:/opt/app/conf/conf.json
      - ./results:/opt/app/resilience-tests
    environment:
      - DISK_PATH=/opt/app/resilience-tests
      - CONFIG_FILE=/opt/app/conf/conf.json
      - ENVOY_FAULT_INJECTION_PATH=/opt/app/fault-injection
      - DOCKER_HOST=/var/run/docker.sock
      - TIME_ZONE=America/Sao_Paulo
    depends_on:
      - resilience4j
      - polly

  proxy:
    image: ghcr.io/shopify/toxiproxy
    ports:
      - 8474:8474
      - 9909:9909
      - 9908:9908

  server: 
    image: envoyproxy/envoy:tools-dev
    ports:
      - 9901:9901
      - 9211:9211

  # server:
  #   build:
  #     context: server
  #   container_name: server
  #   ports:
  #     - 9901:9901
  #     - 9211:9211
  #   volumes:
  #     - ./runtime:/srv/runtime
